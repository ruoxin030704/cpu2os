# 第二章：LLVM IR

## LLVM的中間表示(IR)

LLVM IR是一種靜態單資源資料流圖，用於表示程式的中間表示。LLVM IR具有以下特點：

1. 靜態：LLVM IR表示程式的靜態結構，包括變數、函數、指令等。
2. 單資源：LLVM IR中每個資源只能被一個指令使用，這種約束可以讓LLVM的優化器更容易進行優化。
3. 資料流圖：LLVM IR使用資料流圖的形式表示程式的計算，每個指令的輸入和輸出都是資料流。
4. 支援多種資料型別：LLVM IR支援多種資料型別，如整數、浮點數、向量等。

### LLVM IR的基本結構

LLVM IR由模組（Module）、函數（Function）、基本塊（Basic Block）和指令（Instruction）等元素組成。

模組是LLVM IR的最高層次結構，包含了所有的函數。每個函數由多個基本塊組成，基本塊是一個有序的指令序列，並且保證只有一個入口和一個出口。指令是LLVM IR中最小的計算單位，每個指令都包含了操作符、輸入和輸出等資訊。

## LLVM IR的常用指令

LLVM IR支援多種指令，包括算術指令、位指令、轉換指令、存取指令、控制流指令等。常用的指令包括：

* add：加法指令
* sub：減法指令
* mul：乘法指令
* div：除法指令
* icmp：整數比較指令
* fcmp：浮點數比較指令
* and/or/xor：位運算指令
* load/store：存取指令
* call：函數調用指令
* br：無條件跳轉指令
* switch：多路分支指令
* phi：phi指令

## LLVM IR的資料型別

LLVM IR支援多種資料型別，包括整數、浮點數、向量等。LLVM IR使用了靜態型別檢查，可以在編譯時檢查型別錯誤。

## LLVM IR的目標平台

LLVM IR可以轉換為多種目標平台上的代碼，包括x86、ARM、MIPS等，每種目標平台都有不同的優化技術和限制，需要對LLVM IR進行相應的優化。例如，在ARM平台上，可以使用NEON指令集對LLVM IR進行向量化優化，以提高代碼效率。

## LLVM IR的基本語法

LLVM IR（LLVM Intermediate Representation）是一種中間語言，它是LLVM編譯器的核心組件之一。LLVM IR可以看作是一種低階的組合語言，但它比機器語言更高級，同時也比高級語言更低級。以下是LLVM IR的基本語法：

1. 宣告變數：使用%開頭的符號表示變數，並指定其類型。例如：

```llvm
%i = alloca i32
```

此代碼表示宣告了一個i32類型的整數變數%i。

2. 宣告函數：使用declare關鍵字來宣告函數，指定函數的返回類型和參數類型。例如：

```llvm
declare i32 @add(i32, i32)
```

此代碼表示宣告了一個名為add的函數，返回一個i32類型的整數，接受兩個i32類型的整數作為參數。

3. 定義函數：使用define關鍵字來定義函數，指定函數的返回類型、函數名稱和參數列表。例如：

```llvm
define i32 @add(i32 %a, i32 %b) {
  %sum = add i32 %a, %b
  ret i32 %sum
}

```

此代碼表示定義了一個名為add的函數，返回一個i32類型的整數，接受兩個i32類型的整數作為參數。函數內部使用add指令計算a和b的和，並將結果返回。

4. 指令：LLVM IR中的指令用關鍵字表示，例如add、sub、mul等。每條指令都包含一個操作碼和一些操作數。例如：

```llvm
%sum = add i32 %a, %b
```

此代碼表示使用add指令將變數a和b相加，並將結果存儲到變數sum中。

5. 標籤：LLVM IR中的標籤用關鍵字表示，例如label。標籤用於標識代碼中的某個位置，通常用於控制轉移指令，例如分支或迴圈。例如：

```llvm
start:
  %i = phi i32 [ 0, %entry ], [ %nexti, %loop ]
  ...

```

此代碼表示定義了一個名為start的標籤，並使用phi指令將%i變數的值設置為0或%

## IR的指令和操作

LLVM IR指令和操作包括以下幾種：

1. 賦值指令：賦值指令用於將一個值賦給一個變數。例如：

```llvm
%var = add i32 %a, %b
```

這個指令將變數a和b相加，然後將結果存儲到變數var中。

2. 算術指令：算術指令用於執行算術運算，例如加、減、乘、除等。例如：

```llvm
%result = add i32 %a, %b
```

這個指令將變數a和b相加，然後將結果存儲到變數result中。

3. 比較指令：比較指令用於比較兩個值的大小或相等性。例如：

```llvm
%cmp = icmp eq i32 %a, %b
```

這個指令比較變數a和b是否相等，如果相等，則將變數cmp設置為1，否則設置為0。

4. 分支指令：分支指令用於根據條件進行分支。例如：

```llvm
br i1 %cmp, label %true_label, label %false_label

```

這個指令比較變數cmp的值是否為1，如果是，則跳轉到true_label標籤所標識的位置，否則跳轉到false_label標籤所標識的位置。

5. 迴圈指令：迴圈指令用於實現迴圈控制流。例如：

```llvm
br label %loop_start

loop_start:
  %i = phi i32 [ 0, %entry ], [ %nexti, %loop ]
  ...
  %cmp = icmp slt i32 %i, 10
  br i1 %cmp, label %loop_start, label %after_loop

```

6. 聚合指令：聚合指令用於處理數組、結構體等聚合數據類型。例如：

```llvm
%ptr = getelementptr i32, i32* %array_ptr, i32 %index
%value = load i32, i32* %ptr

```

這個指令使用getelementptr指令計算出指向數組中特定元素的指針ptr，然後使用load指令將該元素的值載入到變數value中。

7. 函數呼叫指令：函數呼叫指令用於調用函數。例如：

```llvm
%result = call i32 @my_function(i32 %arg1, i32 %arg2)
```

這個指令調用名為my_function的函數，並傳遞arg1和arg2作為參數，然後將函數返回值存儲到變數result中。

8. 其他指令：還有許多其他類型的指令，例如存儲指令、加載指令、位操作指令、類型轉換指令等等。

總之，LLVM IR指令和操作提供了一種中間表示形式，可以方便地進行優化和轉換，並且具有豐富的功能和靈活性。



## LLVM IR與其他中間表示的比較

LLVM IR與其他中間表示形式的比較可以從以下幾個方面進行：

1. 易讀性：相對於其他中間表示形式，LLVM IR具有較高的可讀性和易理解性，因為它更接近高級編程語言，而且其指令和操作具有清晰的語義。

2. 轉換性：LLVM IR可以方便地轉換為其他中間表示形式，例如LLVM IR可以轉換為機器碼，也可以轉換為其他高級編程語言的代碼。這使得LLVM IR在編譯器和代碼轉換工具中得到廣泛應用。

3. 靈活性：相對於其他中間表示形式，LLVM IR具有更高的靈活性，因為它可以支持多種編程語言和平台，並且具有豐富的指令和操作，可以實現複雜的編譯優化和轉換。

4. 效能：相對於其他中間表示形式，LLVM IR具有較高的效能，因為它具有先進的編譯優化和代碼生成技術，可以生成高效的機器碼。

總的來說，LLVM IR具有較高的可讀性、轉換性、靈活性和效能，這使得它成為現代編譯器和代碼轉換工具中的重要中間表示形式。

