## RISC-V 的特權指令(以實例解說)

RISC-V 指令集架構是以精簡指令集(Reduced Instruction Set Computing, RISC)設計理念為基礎，其中也包含特權指令。此處所謂的特權指令，是指只有特權模式才能夠使用的指令。在 RISC-V 中，特權模式是指資訊系統硬體所執行的模式，不同於使用者模式。

RISC-V 指令集架構規定，所有的特權指令都必須以 csrrw、csrrs、csrrc 和 csrrwi、csrrsi、csrrci 六種 CSR 指令之一的形式出現。在 RISC-V 中，CSR 是控制和狀態寄存器(Control and Status Register)的縮寫，用於控制和監控處理器的行為。下面是幾個具體的示例，詳細說明了幾種常見的特權 CSR 寄存器。

### mtvec：外部中斷向量表

`mtvec` CSR 寄存器保存外部中斷向量表的地址。將地址存儲在該寄存器可以用於將處理程序分流到中斷服務例程。如果寄存器被寫入，mtvec 的最低兩位必須為 0，因為外部中斷向量表必須對齊 4 字節或 2 字節。

### mstatus: 狀態寄存器

`mstatus` CSR 寄存器用於保存一些重要的標誌位、機器模式下的中斷使能狀態以及某些操作系統指令行為的相關狀態。其中一些位與特權指令有關。下表顯示了 mstatus 寄存器位的描述:

| 位 | 名稱   | 描述                                                         |
|----|--------|----------------------------------------------------------------|
| 0  | UIE    | 前景模式下的中斷使能                                          |
| 3  | MIE    | 機器模式下的中斷使能                                          |
| 7  | MPIE   | 機器模式在 MPIE 設置為 1 時，mstatus 中斷使能被保存在 mpp 中 |
| 11 | MPP[1:0] | 當前機器模式                                                 |
| 18 | MXR    | 訪問類型加速 (AX) 允許讀取 Page Table 的 Page Table 屬性位  |
| 19 | SUM    | 當前 SMBASE, SFENCE.VMA 和 VM 相關的一些操作系統行為控制位    |

### mip/mie：中斷使能位

`mip` 是 Machine-Level Interrupt Pending 的縮寫，實現機械級別的中斷，例如 Timer 中斷和外部 I/O 中斷。`mie` 是 Machine-Level Interrupt Enable 的縮寫，用於在機器模式下啟用或禁用中斷。

這些寄存器的結構類似，他們都包含了以下欄位：

| 位  | 名稱   | 描述                                                        
|----|--------|----------------------------------------------------------------|
| 3  | MEI    | Machine timer 中斷使能                              
| 7  | SEI    | Supervisor timer 中斷使能                                        
| 11 | MTI    | 性能計數器中斷使能    
| 31 | UEI    | 現在未被用於 RISC-V

### satp：存取 TLB 的頁表

`satp` CSR 寄存器用於控制實現多層全局頁表(GSAT) 再入快取的虛擬存儲器管理(VMM)的行為。如果只有單層頁表，那麼只有最低的 22 位有效。下表顯示了 satp 寄存器的格式:

| 位  | 名稱     | 描述              
|-----|----------|-------------------|
| 63-44 | 保留     | 保留用途 |
| 43-22 | PPN      | 頁表的物理地址  |
| 21-0  | MODE     | 頁表模式          |

當 MODE = 0 時， SATP 的下層是可選的。從MODE函數返回 p 是 32，返回 S 是 36，返回 HV 是 16。

### sstatus: 監控模式寄存器

`sstatus` CSR 寄存器用於保存一些重要的標誌位、監控模式下的中斷使能狀態以及某些操作系統指令行為的相關狀態。其中一些位與特權指令有關。下表顯示了 sstatus 寄存器位的描述:

| 位 | 名稱   | 描述                                                         |
|----|--------|----------------------------------------------------------------|
| 0  | UIE    | 用戶模式下的中斷使能                                          |
| 1  | SPIE   | 監控模式下的中斷使能                                          |
| 5  | SPP    | 當前監控模式                                                 |
| 8  | MXR    | 訪問類型加速 (AX) 允許讀取 Page Table 的 Page Table 屬性位  |
| 9  | SUM    | 當前 SMBASE, SFENCE.VMA 和 VM 相關的一些操作系統行為控制位    |

### sie/sip：監控模式下的中斷使能

`sip` 是 Supervisor-Level Interrupt Pending 的縮寫，實現監控級別的中斷，例如軟件異常、閒置時鐘異常等。`sie` 是 Supervisor-Level Interrupt Enable 的縮寫，用於在告知申請中斷之前啟用或禁用中斷。

這些寄存器的結構類似，他們都包含了以下欄位：

| 位  | 名稱  | 描述                                                         |
|-----|-------|----------------------------------------------------------------|
| 1  | USIE  | 當前記錄 SIE 值                                              |
| 5  | UTIE  | 當前記錄 SIE 值   
| 9  | UMIE  | 當前記錄 SIE 值                                              |

上述特權 CSR 寄存器是 RISC-V 处理器中常见的特权寄存器。通过这些寄存器和相应的特权指令，可以在不同的特权模式下控制和监测处理器的状态，实现进程和输入输出的管理、任务调度、中断处理、虚拟内存管理等功能。理解这些寄存器和相应指令的操作和作用，对于学习和设计 RISC-V 处理器和系统具有重要的参考价值。