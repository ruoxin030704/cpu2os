## RISC-V 的 MMU 記憶體管理單元

MMU（Memory Management Unit）翻譯為中文就是記憶體管理單元，是一塊硬體電路，它負責在處理器和內存之間進行地址轉換及存取權限控制。在硬體層面上，RISC-V的MMU的功能與其他CPU類似。下面我們將進一步介紹RISC-V MMU的功能與設計。

RISC-V的MMU處理器主要目的是為了學習，研究和實現不同的記憶體管理和安全策略，包括提供操作系統與應用程序的分頁機制。RISC-V的MMU實現了CPU與實際記憶體物理地址之間的映射，進而支持虛擬地址空間的概念。虛擬地址是指程序中進程所使用的地址，可以大於物理地址。

為了實現MMU的功能，RISC-V處理器需要支持以下功能：

- 虛擬地址翻譯：將虛擬地址轉換為實際的記憶體物理地址；
- 存取權限控制：根據權限設定，限制指令對特定物理內存區域的存取；
- 頁表：將虛擬內存區域映射到物理內存區域。

RISC-V的MMU通過分頁機制來實現虛擬地址轉換功能。在這個機制中，一個程序的虛擬地址空間被劃分為固定大小的頁，物理內存空間也被劃分為等同大小的頁。當程序訪問一個虛擬地址時，MMU需要查詢頁表， 以便確定該虛擬地址是哪個頁，進而計算出實際的物理地址。RISC-V的MMU支援RISC-V指令集中所定義的頁表格式。

除了虛擬地址轉換功能外，MMU還用於執行存取權限控制。該機制根據權限設定，將某些內存區域鎖定，以防止進程訪問或修改這些區域。MMU還支援粗粒度和細粒度的權限設定。在粗粒度控制中，許多內存區域被分到不同的權限等級下，而在細粒度控制中，同一個內存頁面的不同部分可以在同時支持不同的權限。

簡單而言，MMU是一種硬件機制，它使得操作系統能夠用虛擬地址來管理電腦的內存，而不必考慮實際的物理地址。這種轉換是實現網路虛擬化和虛擬化容器的核心，讓一些軟體在同一時間可以在同一硬件裝置上運行，也是一個重要的系統安全措施，保護了普通用戶免受其他可惡用戶破壞性程序的影響。

RISC-V 針對記憶體管理單元 (MMU) 提供了一個基本的框架，該框架的設計是為了使其對外部實現進行儘量少的假設。在 RISC-V 的框架中，一個處理器實現與外部實現之間的通信協定，而不是嘗試進行特定的實現假設。

我們知道，一個虛擬地址對應著一個實體地址，虛擬地址是程序視角中的地址，而實體地址是物理內存地址。在 CPU 的運作中，如果能將虛擬地址直接轉換成實體地址的話，那麼對於程序而言，操作內存會變得更加方便快捷。這就是 MMU 機制的重要作用：通過管理虛擬地址與實體地址之間的映射關係，使得程序可以方便地存取內存，虛擬地址到實體地址的轉換就是 MMU 的主要工作。

而 RISC-V 的 MMU 機制主要和分頁表有關。分頁表是一種 MMU 實現機制，旨在將虛擬地址訪問映射到實體內存地址。RISC-V 官方將分頁表的實現分為了三種不同的模式，即 SV32、SV39 和 SV48 模式。這些都是基於分頁表設計的實現模式，在虛擬地址與實體地址之間進行翻譯時需要使用特定的分頁表，以此實現虛擬地址到實體地址之間的轉換。

## RISC-V 的 SV39 分頁表 MMU 機制

在 RISC-V 中，分頁表 MMU 是實現虛擬內存管理的主要機制之一，它使得不同的應用程序可以共享系統的物理內存而不會互相干擾。其中，SV39 是 RISC-V 處理器中最常見的分頁表 MMU 機制之一，也是最複雜的機制之一。

首先，SV39 是根據 64 位的虛擬地址進行設計的，可以支持最大的虛擬地址空間為 $2^{64}$。SV39 機制中，整個虛擬地址被分為三個部分：高 25 位、中間的 9 位、和低 30 位，如下圖所示：

![RISC-V SV39 對虛擬地址分頁](https://davinci-ai-products.github.io/img/riscv-sv39.png)

其中，高 25 位表示一個虛擬頁表的索引，每個虛擬頁表大小為 $2^{12}$ bytes。中間的 9 位表示一個虛擬頁表中的一個項目（PTE）的索引，每個 PTE 的大小為 8 bytes。最後的 30 位表示虛擬頁內的偏移量，每個虛擬頁大小也為 $2^{12}$ bytes。

在 SV39 機制中，整個虛擬地址空間被分成多級虛擬頁表，每個頁表包含了一個或多個 PTE。而每個 PTE 則描述了一個虛擬頁和物理頁的對應關係，並給出了一些權限信息。PTE 的格式如下所示：

```
63                       0
+------------------------+
| PPN | Flag | Reserved 0 |
+-----+------+-----------+
```

其中，PPN 表示物理頁的頁號，Flag 則表示該 PTE 的權限和一些其他信息。

在 SV39 機制中，最上層的虛擬頁表稱為第一級頁表（L1），它包含了 512 個 PTE。每個 PTE 指向一個第二級頁表（L2)，每個 L2 頁表也包含了 512 個 PTE。同理，每個 L2 指向一個第三級頁表（L3），每個 L3 包含了 512 個 PTE。最後，每個 L3 指向一個物理頁。

下面是一個 SV39 機制的示意圖：

```
+--------------+  +-----+
| L1 PTE Entry |-->| L2  |
+--------------+  +-----+
| L1 PTE Entry |-->| L2  |
+--------------+  +-----+
        .                 .
        .                 .
        .                 .
+--------------+  +-------+
| L1 PTE Entry |-->|  L2   |
+--------------+  +-------+
| L1 PTE Entry |-->|  L2   |
+--------------+  +-------+
        .                 .
        .                 .
        .                 .
+--------------+  +-----+
| L2 PTE Entry |-->| L3  |
+--------------+  +-----+
| L2 PTE Entry |-->| L3  |
+--------------+  +-----+
        .                 .
        .                 .
        .                 .
+--------------+  +-------+
| L3 PTE Entry |-->| Page  |
+--------------+  +-------+
```

當 CPU 需要訪問某個虛擬地址時，它會根據地址的高 25 位找到 L1 頁表對應的 PTE。如果該 PTE 沒有標記為存在，則表示該虛擬頁不存在，進行非法訪問中斷，否則， CPU 會根據 PTE 取得 L2 頁表的首地址，此時 CPU 會用中間的 9 位作為 L2 頁表的索引，然後再繼續查找 L2 頁表。如果 L2 和 L3 頁表都存在，則代表該虛擬頁存在， CPU 會根據 PTE 取得物理頁號 PPN，然後將低 30 位的偏移量加上 PPN 得到物理地址。

總體而言，SV39 機制實現了虛擬內存管理的功能，並可以在不同的層級上描述虛擬頁與物理頁之間的映射關係，從而實現內存的隔離和保護。


### SV32 分頁表

SV32 模式下，虛擬地址的高 2 位 (31:30) 被看作是頁表索引，因此一個虛擬地址可以映射到 $2^22$ 個不同的頁。每個頁表項有 32 比特，其中包含以下字段：

![sv32_pagetable_entry](https://i.imgur.com/RlZrse0.png)

其中核心字段包括以下幾個：

- ppn：表示下一級頁表的物理地址
- rsw：保留位
- d：頁是否可寫
- a：頁是否被訪問過
- g：全域位，表示頁表項被全局引用時會被設置
- u：用戶位，僅在供應用程序使用的頁表中才會被設置
- x：頁是否可執行
- w：頁是否可寫
- r：頁是否可讀取
- v：頁是否有效

在 RISC-V SV32 模式中，有兩種類型的頁表項：PT 和 PTE。

所謂的 PT，是指一級頁表本身，這是一個單獨的頁表，其中包含 N 個 PTE，每個 PTE 又指向一個下一級的頁表。每個 PT 在 CPU 處理器開機啟動時由機器代碼進行設置，並且在頁表的整個生命週期中不可修改。PT 可以通過將它的物理地址存放在 satp 寄存器中來啟用。

另一個類型的頁表項是 PTE。在具體實現中，將 PTE 組成的單元稱為頁表鏈。在頁表鏈中，每個 PTE 指向一個物理內存頁，而如果該 PTE 沒有子項目，那麼該 PTE 就是頁錶鏈的終止項目。

需要注意的是，在 SV32 分頁表模式中，一個虛擬地址可以映射到三級的物理地址。當一個頁錶項的有效位為 0 時，表示該項目指向的下一級頁表不存在；而換言之，如果一個 PT 轉換后的 PTE 的有效位為 0，則實體地址就是新的虛擬地址。

在 RISC-V 處理器中，關於 MMU 的其他實現細節還有很多，這裡我們僅就基礎的 SV32 分頁表進行簡單介紹，作為初步了解 MMU 設計的一個參考。