# 第二章：語法分析

語法分析是編譯器的第一個階段，主要負責將源代碼轉換為語法樹（Parse Tree）或抽象語法樹（Abstract Syntax Tree，AST）。

本章將主要討論以下內容：

1. 語法和語法樹的定義
2. 語法分析器的設計和實現
3. 語法錯誤的處理方法
4. 語法和語法樹

## 語法分析的概念和作用

語法是一門自然語言或編程語言的結構和規則，描述了該語言中合法的詞法和句法形式。語法樹是一種以樹狀結構表示語言結構的數據結構。語法樹的根節點表示整個程序，每個子節點表示一個語法結構。

### 語法分析器

語法分析器是編譯器的第一個階段，負責將源代碼轉換為語法樹或抽象語法樹。常見的語法分析方法包括：

* 遞歸下降分析法（Recursive Descent Parsing）：遵循自頂向下的分析方法，根據語法規則逐步構造語法樹。
    * [遞歸下降解析器](https://zh.wikipedia.org/zh-tw/%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E8%A7%A3%E6%9E%90%E5%99%A8)
* 自動機分析法（Automaton Parsing）：根據編程語言的有限狀態自動機模型進行分析，包括有限狀態機分析和LR分析等。
* 預測分析法（Predictive Parsing）：使用預測分析表進行分析，根據當前的語法符號和後綴符號預測下一個語法符號。
    * https://www.geeksforgeeks.org/predictive-parser-in-compiler-design/
* Earley分析法（Earley Parsing）：使用Earley算法進行自下而上的分析，可以處理包含循環和遞歸的語法。
    * https://en.wikipedia.org/wiki/Earley_parser

### 語法錯誤處理

語法錯誤是指源代碼中不符合語法規則的部分，語法分析器需要能夠檢測這些錯誤並進行處理。常見的語法錯誤包括：

* 缺少分號或右括號等結束符號
* 不完整的表達式或語句
* 不合法的操作符或操作數
* 語法不一致的嵌套結構

語法分析器通常會報告第一個發現的語法錯誤，並且停止分析過程，但也可以選擇繼續分析並報告所有語法錯誤。對於一些較嚴格的語言，語法分析器可能會使用更複雜的方法進行語法檢查，例如對代碼進行多次遍歷或使用上下文無關文法進行分析。

## 自上而下分析和自下而上分析的區別

自上而下分析（ Top-down Parsing ）和自下而上分析（Bottom-up Parsing）是兩種常見的語法分析方法，它們的主要區別在於分析的起點和推導的方向。

* https://en.wikipedia.org/wiki/Top-down_parsing
* https://en.wikipedia.org/wiki/Bottom-up_parsing

自上而下分析是從文法的起始符號開始，通過應用文法規則向下推導，直到匹配輸入字符串。這種方法從上往下建構語法樹，因此也稱為預測分析法。自上而下分析方法包括遞歸下降分析法、預測分析法等。

自下而上分析是從輸入字符串開始，通過不斷地將輸入符號推入堆棧中，直到最終推導出文法的起始符號。這種方法從下往上建構語法樹，因此也稱為移入-歸納分析法。自下而上分析方法包括LR分析法、LALR分析法等。

自上而下分析的優點是對於簡單的文法能夠進行快速分析，並且可以較容易地進行錯誤處理和錯誤恢復。自下而上分析的優點是對於複雜的文法能夠進行分析，並且可以自動構建語法樹。

綜合來看，自上而下分析和自下而上分析各有優缺點，選擇哪種方法取決於所處的具體情況，例如文法的複雜度、效率和錯誤處理等需求。

## 預測分析法和SLR分析法的實現

### 預測分析法的實現

* https://www.geeksforgeeks.org/predictive-parser-in-compiler-design/

預測分析法是自上而下分析法中的一種，通過應用文法規則來進行預測，從而生成語法樹。以下是一些實現預測分析法的步驟：

1. 定義文法和文法符號集。文法應該是上下文無關的，可以用BNF（巴科斯范式）等形式進行表示。

2. 創建一個堆棧，並將起始符號壓入堆棧中。

3. 從輸入串中讀取下一個符號，稱為「展望符號」（look-ahead symbol）。

4. 從堆棧頂部彈出一個符號，稱為「現在符號」（current symbol）。

5. 如果現在符號是一個非終端符號，則使用文法規則進行展開，並將展開後的符號按照適當的順序壓入堆棧中。如果現在符號是一個終端符號，則檢查它是否和展望符號匹配。如果匹配成功，則從輸入串中讀取下一個符號作為新的展望符號；否則表示匹配失敗，需要進行錯誤處理。

6. 重複步驟4和步驟5，直到堆棧為空或者匹配失敗。

預測分析法的實現相對簡單，但是它的主要缺點是對於複雜的文法可能存在回溯，且效率較低。因此，在實際應用中，預測分析法通常用於處理簡單的語言。

### SLR分析法的實現

* https://www.geeksforgeeks.org/slr-parser-with-examples/

SLR（Simple LR）分析法是自下而上分析法中的一種，相對於其他自下而上分析法來說，它的實現相對較簡單，並且對於複雜的文法也能夠進行有效的分析。以下是一些實現SLR分析法的步驟：

1. 創建LR分析表。這個表是一個二維表格，其中的每一個格子都表示一個LR項目（LR item）。LR項目是一個形如「A -> α . β」的項目，其中A表示一個文法符號，α和β分別表示由終端與非終端項目組合成的序列。

2. 創建LR項目集合。一個LR項目集合是由多個LR項目組成的集合，其中每個項目都有形如「A -> α . β」的形式。創建過程中，首先將起始符號的LR項目加入第一個LR項目集合中，然後進行一系列的項目擴展操作，直到所有可能的項目集合都被創建出來。

3. 構建LR自動機。LR自動機是一個有限狀態機，其中每個狀態對應一個LR項目集合，並且每個狀態都可以通過某個文法符號轉移到另一個狀態。

4. 填充LR分析表。在填充分析表格的過程中，需要對每個LR項目進行移進（shift）和歸納（reduce）操作，以決定下一步應該移動到哪個狀態或者進行哪個文法符號的歸納。

5. 使用LR分析表進行語法分析。當輸入一個詞彙串時，將其轉換為一系列的符號，並將其壓入分析堆棧中。接著，從堆棧頂部彈出一個符號，並根據LR分析表格中的信息進行相應的移進或者歸納操作。如果在分析過程中發現錯誤，則需要進行錯誤處理。

6. SLR分析法是自下而上分析法中的一種，相對於其他自下而上分析法來說，它的實現相對簡單，並且對於複雜的文法也能夠進行有效的分析。因此，它被廣泛用於實際的編譯器設計中。

## LR分析法和LALR分析法的原理和實現

LR分析法和LALR分析法也是自下而上分析法中的兩種，它們相對於SLR分析法來說，能夠處理更複雜的文法，並且產生的分析表格也更加緊湊。

### LR分析法

* https://en.wikipedia.org/wiki/LR_parser

LR分析法是一種基於LR自動機的語法分析方法，它利用預測分析法和LR項目集合來實現語法分析。LR分析法的基本思想是，對於任意一個文法符號，都可以根據當前的狀態和堆棧頂部的符號來決定下一步應該採取的動作，包括移進、歸納和接受。

LR分析法的實現過程大致包括以下幾個步驟：

1. 構造LR自動機。與SLR分析法類似，首先需要創建LR項目集合，然後構建LR自動機，其中每個狀態對應一個LR項目集合，並且每個狀態都可以通過某個文法符號轉移到另一個狀態。

2. 填充LR分析表。LR分析表格是一個二維數組，其中每個單元格對應一個狀態和一個文法符號，並且包含了當前狀態下應該採取的動作。填充分析表格的過程中，需要對每個LR項目進行移進（shift）和歸納（reduce）操作，以決定下一步應該移動到哪個狀態或者進行哪個文法符號的歸納。

3. 使用LR分析表進行語法分析。當輸入一個詞彙串時，將其轉換為一系列的符號，並將其壓入分析堆棧中。接著，從堆棧頂部彈出一個符號，並根據LR分析表格中的信息進行相應的移進或者歸納操作。如果在分析過程中發現錯誤，則需要進行錯誤處理。

LR分析法的優點是能夠處理較為複雜的文法，並且產生的分析表格也相對緊湊

### LALR分析法

* https://en.wikipedia.org/wiki/LALR_parser

LALR分析法是一種基於LR分析法的改進，它通過合併LR自動機中的某些狀態，從而減少了分析表格的大小。LALR分析法的基本思想是，在LR項目集合中合併具有相同核心的項目集合，從而減少狀態的數量，進而減少分析表格的大小。

LALR分析法的實現過程大致與LR分析法類似，只是在構造LR項目集合和填充LR分析表格的過程中，需要進行一些合併操作。具體而言，LALR分析法的實現過程包括以下幾個步驟：

1. 構造LR項目集合。與LR分析法類似，首先需要構造LR項目集合，並且通過歸納操作，構造LALR項目集合。

2. 合併LALR項目集合。為了減少狀態的數量，需要將具有相同核心的LALR項目集合合併成一個新的項目集合。

3. 填充LALR分析表。與LR分析法類似，需要根據LALR項目集合和自動機中的轉移關係，填充LALR分析表格。

4. 使用LALR分析表進行語法分析。與LR分析法類似，需要將輸入詞彙串轉換為一系列符號，並將其壓入分析堆棧中。接著，從堆棧頂部彈出一個符號，並根據LALR分析表格中的信息進行相應的移進或者歸納操作。如果在分析過程中發現錯誤，則需要進行錯誤處理。

LALR分析法相對於LR分析法來說，能夠減少狀態的數量和分析表格的大小，從而提高分析效率。但是，由於合併操作可能會導致一些語法歧義的問題，因此需要特別關注語法歧義的處理。
